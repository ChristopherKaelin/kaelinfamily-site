---
import BaseLayout from "../layouts/BaseLayout.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { sanityClient } from "../../sanity.config.js";
import { categoriesWithCounts as importedCategories } from "../pages/utils/CategoryMeta.astro";

// Fetch all top level categories
const categories: any[] = await sanityClient.fetch(`
  *[_type == "category"] | order(title asc) {
    _id,
    title,
    "slug": slug.current,
    description,
    "directPosts": count(*[_type == "post" && references(^._id)]),
    "childCategoryIds": *[_type == "category" && parent._ref == ^._id]._id,
  }
`);

// Calculate post counts manually for each category
const categoriesWithCounts = await Promise.all(categories.map(async (category) => {
  let childPostCount = 0;
  
  if (category.childCategoryIds && category.childCategoryIds.length > 0) {
    childPostCount = 0;
    // Count posts for each child category individually and sum them
    for (const childId of category.childCategoryIds) {
      const postsInChild = await sanityClient.fetch(`
        count(*[_type == "post" && references("${childId}")])
      `);
      childPostCount += postsInChild;
    }
  }
  
  return {
    ...category,
    childPostCount: childPostCount,
    postCount: category.directPosts + childPostCount
  };
}));

---

<BaseLayout title={`Categories - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
  <!-- your categories content here (everything that was inside <main>) -->
  <section>
    <h1>All Categories</h1>
    <div class="categories-grid">
      {
        categoriesWithCounts.map((category) => (
          <div class="card">
            <a href={`/category/${category.slug}`}>
              <h3>{category.title}</h3>
            </a>
            <p class="post-count">{category.postCount} posts</p>
            <p>{category.description}</p>
          </div>
        ))
      }
    </div>
  </section>
</BaseLayout>

<style>
  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
  }

  .post-count {
    color: #666;
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }

  @media (max-width: 760px) {
    .categories-grid {
      grid-template-columns: 1fr;
    }
    .category-card {
      padding: 0.5rem;
    }
    .category-card h3 {
      font-size: 1.25rem;
    }
    .category-card p {
      font-size: 0.875rem;
    }
  }

  @media (max-width: 480px) {
    .category-card h3 {
      font-size: 1.1rem;
    }

    .category-card p {
      display: none;
    }
  }
</style>
