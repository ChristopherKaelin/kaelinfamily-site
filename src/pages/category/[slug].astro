---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostList from "../../components/PostList.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";
import { sanityClient } from "../../../sanity.config.js";

export async function getStaticPaths() {
  const categories: any[] = await sanityClient.fetch(`
    *[_type == "category"] {
      title,
      "slug": slug.current,
      description
    }
  `);

  return categories.map((category) => ({
    params: { slug: category.slug },
    props: {
      categoryTitle: category.title,
      categorySlug: category.slug,
      categoryDescription: category.description,
    },
  }));
}

const { categoryTitle, categorySlug, categoryDescription } = Astro.props;

const posts: any[] = await sanityClient.fetch(`
  *[_type == "post" && (
    references(*[_type == "category" && slug.current == "${categorySlug}"]._id) ||
    references(*[_type == "category" && parent->slug.current == "${categorySlug}"]._id)
  )] | order(publishedAt desc) {
    _id,
    title,
    slug,
    publishedAt,
    "imageUrl": mainImage.asset->url,
    "categories": categories[]->{title, "slug": slug.current},
    "excerpt": array::join(string::split(pt::text(body), "")[0..150], "") + "..."
  }
`);
---

<BaseLayout
  title={`${categoryTitle} - ${SITE_TITLE}`}
  description={SITE_DESCRIPTION}
>
  <div class="category-header">
    <h1>{categoryTitle}</h1>
    {
      categoryDescription && (
        <p class="category-description">{categoryDescription}</p>
      )
    }
    <div class="category-stats">
      {posts.length}
      {posts.length === 1 ? "post" : "posts"}
    </div>
  </div>

  {
    posts.length > 0 ? (
      <section>
        <PostList posts={posts} variant="grid" />
      </section>
    ) : (
      <div class="no-posts">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" >
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <h2>No posts found</h2>
        <p>There are no posts in this category yet. Check back later!</p>
        <a href="/blog" class="back-to-blog">
          ‚Üê Back to all posts
        </a>
      </div>
    )
  }
</BaseLayout>

<style>
  .category-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-large);
    border-bottom: 2px solid var(--color-border);
  }

  .category-header h1 {
    font-size: var(--font-size-xxl);
    color: var(--color-primary);
    margin-bottom: var(--spacing-base);
  }

  .category-description {
    font-size: var(--font-size-large);
    color: var(--color-muted);
    margin-bottom: var(--spacing-base);
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }

  .category-stats {
    color: var(--color-accent);
    font-weight: 500;
  }

  .no-posts {
    text-align: center;
    padding: var(--spacing-xl) 0;
    color: var(--color-muted);
  }

  .no-posts svg {
    margin-bottom: var(--spacing-base);
    opacity: 0.5;
  }

  .no-posts h2 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-base);
  }

  .back-to-blog {
    display: inline-block;
    margin-top: var(--spacing-large);
    padding: 0.75rem 1.5rem;
    background: var(--color-accent);
    color: white;
    text-decoration: none;
    border-radius: var(--border-radius-base);
    font-weight: 500;
    transition: var(--transition-fast);
  }

  .back-to-blog:hover {
    background: var(--color-primary);
    transform: translateY(-2px);
  }
</style>
