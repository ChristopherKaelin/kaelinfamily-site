---
import BaseLayout from "../layouts/BaseLayout.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { sanityClient } from "../../sanity.config.js";
import FormattedDate from "../components/FormattedDate.astro";

// Better SEO values for home page
const homeTitle = "Kaelin Family Blog - Stories from Kentucky";
const homeDescription =
  "Family stories, tech adventures, recipes, and life in Kentucky. Join Chris Kaelin for heartwarming tales, coding projects, and genuine conversation from the Bluegrass State.";

//  If text length > maxLength, return the truncated the text.
function truncateText(text: string, maxLength: number = 250): string {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + "...";
}

// Helper function to get primary category for styling
function getPrimaryCategorySlug(categories: any[]) {
  if (!categories || categories.length === 0) return "default";
  const category = categories[0];

  // Use parent category if it exists, otherwise use the category itself
  if (category.parent && category.parent.slug) {
    return category.parent.slug.toLowerCase().replace(/\s+/g, "-");
  }

  return category.slug.toLowerCase().replace(/\s+/g, "-");
}

// Fetch all top level categories
const categories: any[] = await sanityClient.fetch(`
  *[_type == "category" && !defined(parent)] | order(sortOrder asc) {
    title,
    "slug": slug.current,
    description,
    subtitle,
    icon,
    color
  }
`);

// Fetch the 8 most recent posts
const recentPosts: any[] = await sanityClient.fetch(`
  *[_type == "post"] | order(publishedAt desc)[0...8] {
    _id,
    title,
    slug,
    publishedAt,
    "imageUrl": mainImage.asset->url,
    "categories": categories[]->{
      title, 
      "slug": slug.current,
      "parent": parent->{title, "slug": slug.current}
    }
  }
`);
---

<BaseLayout title={homeTitle} description={homeDescription}>
  <section class="hero">
    <h1>Welcome to the Kaelin Family Blog</h1>
    <p class="intro">
      Hey there! I am Chris, and this is where I will share stories
      about family, tech adventures, good food, and life in Kentucky. Whether
      you're here for family tales, tech tips, recipe ideas, or just some good
      conversation, you're always welcome at our virtual table. Grab a cup of
      coffee, pull up a chair and make yourself at home!
    </p>
  </section>

  <!-- Dynamic Categories -->
  <section class="categories-overview">
    <h2>What You'll Find Here</h2>
    <p>I write about the things that bring joy and meaning to my life:</p>

    <div class="category-grid">
      {
        categories.map((category) => (
          <a
            href={`/category/${category.slug}`}
            style={`border-left: 10px solid ${category.color.hex}`}
            class={`category-button`}
          >
            <h3>
              {category.icon} {category.title}
            </h3>
            <p>{category.subtitle}</p>
          </a>
        ))
      }
    </div>
  </section>

  <section class="recent-posts">
    <h2>Latest from the Blog</h2>
    <p>Here's what I've been writing about lately:</p>

    <div class="posts-preview">
      {
        recentPosts.map((post) => (
          <article
            class={`post-preview post-preview--${getPrimaryCategorySlug(post.categories)}`}
          >
            <h3>
              <a href={`/${post.categories[0].slug}/${post.slug.current}/`}>{post.title}</a>
            </h3>
            <span class="post-date">
              <FormattedDate date={new Date(post.publishedAt)} />
            </span>
            <span class="post-categories">
              {" "}
              in
              {post.categories &&
                post.categories.length > 0 &&
                post.categories.map((cat: any) => cat.title).join(", ")}
            </span>
          </article>
        ))
      }
      <article class="post-preview post-preview--all">
        <h4><a href="/blog">View all posts â†’</a></h4>
      </article>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero Section */
  .hero {
    text-align: center;
    margin-bottom: var(--spacing-xl);
    padding: 0;
  }

  .hero h1 {
    font-size: var(--font-size-xxl);
    margin-bottom: var(--spacing-large);
    color: var(--color-primary);
  }

  .intro {
    font-size: var(--font-size-large);
    line-height: 1.5;
    max-width: 75%;
    margin: 0 auto var(--spacing-base);
    color: var(--color-accent);
  }

  .subtitle {
    font-size: var(--font-size-base);
    line-height: 1.25;
    color: var(--color-muted);
    max-width: 600px;
    margin: 0 auto var(--spacing-base);
  }

  .work-in-progress {
    background-color: var(--color-warning-light);
    border: 1px solid var(--color-warning);
    color: var(--color-accent);
    padding: var(--spacing-large);
    border-radius: var(--border-radius-large);
    margin: var(--spacing-large) auto;
    max-width: 80%;
    text-align: left;
  }

  .work-in-progress .title {
    font-weight: bold;
    font-size: var(--font-size-large);
    margin-bottom: var(--spacing-small);
    display: block;
    text-align: center;
  }

  .work-in-progress .text {
    display: block;
    line-height: 1.5;
  }

  /* Categories Overview */
  .categories-overview {
    margin-bottom: var(--spacing-xl);
    text-align: center;
  }

  .categories-overview h2 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-base);
  }

  .categories-overview > p {
    color: var(--color-muted);
    margin-bottom: var(--spacing-large);
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 cards across on full screen */
    gap: var(--spacing-large);
    margin-top: var(--spacing-large);
  }

  .category-item {
    background: var(--color-bg);
    padding: var(--spacing-base);
    border-radius: var(--border-radius-large);
    border: 1px solid var(--color-border);
    text-align: left;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-small);
    text-decoration: none;
    color: inherit;
  }

  .category-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-base);
    color: var(--color-primary-light);
  }

  .category-item h3 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-small);
    font-size: var(--font-size-large);
  }

  .category-item p {
    color: var(--color-muted);
    line-height: 1.25;
    margin: 0;
    font-size: var(--font-size-base);
  }

  /* Recent Posts */
  .recent-posts {
    margin-bottom: var(--spacing-xl);
  }

  .recent-posts h2 {
    color: var(--color-primary);
    margin-bottom: var(--spacing-base);
    text-align: center !important;
  }

  .recent-posts > p {
    text-align: center;
    color: var(--color-muted);
    margin-bottom: var(--spacing-large);
  }

  .posts-preview {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 4 cards across on full screen */
    gap: var(--spacing-large);
    margin-bottom: var(--spacing-large);
  }

  .post-preview {
    background: var(--color-cream-400) !important;
    padding: var(--spacing-large);
    border-radius: var(--border-radius-base);
    border: 1px solid var(--color-border);
    transition: var(--transition-fast);
  }

  .post-preview:hover {
    box-shadow: var(--shadow-base);
  }

  .post-preview h3 {
    margin: 0 0 var(--spacing-small) 0;
  }

  .post-preview h3 a {
    color: var(--color-primary);
    text-decoration: none;
    font-size: var(--font-size-large);
  }

  .post-preview h3 a:hover {
    text-decoration: underline;
  }

  .post-date {
    color: var(--color-muted);
    font-size: var(--font-size-small);
    margin: 0;
  }

  .post-categories {
    color: var(--color-accent);
    font-size: var(--font-size-small);
    margin: 0;
    font-style: italic;
  }

  .view-all {
    text-align: center;
  }

  .view-all-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: bold;
    font-size: var(--font-size-large);
  }

  .view-all-link:hover {
    text-decoration: underline;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    /* 3 columns on medium screens */
    .category-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 900px) {
    .hero h1 {
      font-size: var(--font-size-xl);
    }

    .work-in-progress {
      max-width: 95%;
      padding: var(--spacing-base);
    }

    .category-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-base);
    }

    .category-item {
      padding: var(--spacing-base);
    }

    .intro,
    .subtitle {
      font-size: var(--font-size-base);
    }

    .posts-preview {
      grid-template-columns: repeat(
        2,
        1fr
      ); /* 2 cards across at first breakpoint */
      gap: var(--spacing-base);
    }
  }

  @media (max-width: 600px) {
    /* 1 columns */
    .category-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .hero {
      padding: var(--spacing-base) 0;
    }

    .cta-section,
    .categories-overview {
      padding: var(--spacing-base);
    }

    .work-in-progress .title {
      font-size: var(--font-size-base);
    }

    .posts-preview {
      grid-template-columns: 1fr; /* Stacked at second breakpoint */
      gap: var(--spacing-base);
    }

    .post-preview {
      padding: var(--spacing-base);
    }
  }

  .post-preview--all {
    border-left: 6px solid var(--color-primary-900) !important;
  }

  .post-preview--feel-good {
    border-left: 6px solid #6366F1 !important;
  }

  .post-preview--sports {
    border-left: 6px solid var(--color-orange-accent) !important;
  }
</style>
