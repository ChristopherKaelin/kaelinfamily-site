---
import BaseLayout from "../layouts/BaseLayout.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { sanityClient } from "../../sanity.config.js";
import FormattedDate from "../components/FormattedDate.astro";
import heroImage from "../assets/ky-horse-farm.jpg";

// SEO values for home page
const homeTitle = "Kaelin Family - Stories from Kentucky";
const homeDescription =
  "Family stories, tech adventures, recipes, and life in Kentucky. Join Chris and Trish Kaelin for heartwarming tales, coding projects, and genuine conversation from the Bluegrass State.";

// Fetch all top level categories
const categories: any[] = await sanityClient.fetch(`
  *[_type == "category" && !defined(parent)] | order(sortOrder asc) {
    title,
    "slug": slug.current,
    description,
    subtitle,
    icon,
    color,
    "imageUrl": image.asset->url,
    "postCount": count(*[_type == "post" && ^._id in categories[]._ref]) + 
                  count(*[_type == "post" && ^._id in categories[].parent._ref]),
    "test" : "posts"
  }
`);

// Fetch recent posts
const popularPosts: any[] = await sanityClient.fetch(`
  *[_type == "post"] | order(publishedAt desc)[0...4] {
    _id,
    title,
    slug,
    publishedAt,
    "imageUrl": mainImage.asset->url,
    "categories": categories[]->{title, "slug": slug.current}
  }
`);

const featuredPosts: any[] = await sanityClient.fetch(`
  *[_type == "post"] | order(publishedAt desc)[0...5] {
    _id,
    title,
    slug,
    publishedAt,
    "categories": categories[]->{title, "slug": slug.current}
  }
`);
---

<BaseLayout title={homeTitle} description={homeDescription}>
  <!-- Hero Section -->
  <section
    class="hero"
    style={`background-image: linear-gradient(rgba(44, 122, 123, 0.1), rgba(44, 122, 123, 0.2)), url(${heroImage.src});`}
  >
    <div class="hero-overlay"></div>
    <div class="hero-container">
      <div class="hero-content">
        <h1>Welcome to Our Kentucky Story</h1>
        <p>
          Follow our family adventures, discover delicious recipes, and join us
          on our tech journey in the heart of Kentucky
        </p>
        <a href="/blog" class="hero-cta">Explore Latest Posts</a>
      </div>
    </div>
  </section>

  <main class="main-content">
    <!-- Search Section -->
    <!-- <section class="search-section"> -->
    <!-- <h3>What are you looking for?</h3> -->
    <!-- <form class="search-form"> -->
    <!-- <input type="search" class="search-input" placeholder="Search recipes, family stories, tech tips..."> -->
    <!-- <button type="submit" class="search-btn">Search</button> -->
    <!-- </form> -->
    <!-- </section> -->

    <!-- Browse Categories -->
    <section class="browse-categories">
      <h2 class="section-title">Browse Our Stories</h2>
      <div class="categories-grid">
        {
          categories.map((category) => (
            <a href={`/category/${category.slug}`} class="category-card">
              <div class="category-image">
                {category.imageUrl ? (
                  <img
                    src={category.imageUrl}
                    alt={category.title}
                    class="w-full h-full object-cover"
                  />
                ) : (
                  <div class="category-placeholder">{category.icon || ""}</div>
                )}
                <div class="category-overlay" />
              </div>
              <div class="category-content">
                <h3>{category.title}</h3>
                <p>{category.subtitle || category.description}</p>
                <span class="post-count">
                  {category.postCount || 0} recent {category.test}
                </span>
              </div>
            </a>
          ))
        }
      </div>
    </section>

    <!-- Popular & Featured Posts -->
    <section class="posts-sections">
      <div class="popular-posts">
        <h2>Browse Our Popular Posts</h2>
        <div class="posts-grid">
          {
            popularPosts.length > 0 && (
              <>
                <article class="post-card featured">
                  <div class="post-image">
                    {popularPosts[0].imageUrl ? (
                      <img
                        src={popularPosts[0].imageUrl}
                        alt={popularPosts[0].title}
                      />
                    ) : (
                      "Featured Hero Image - Kentucky Fall Family Adventure"
                    )}
                  </div>
                  <div class="post-content">
                    <span class="post-category">
                      {popularPosts[0].categories?.[0]?.title || "Blog"}
                    </span>
                    <h3 class="post-title">{popularPosts[0].title}</h3>
                    <p class="post-excerpt">
                      Discover the incredible story behind this post...
                    </p>
                    <div class="post-meta">
                      <span>6 min read</span>
                      <span>
                        <FormattedDate
                          date={new Date(popularPosts[0].publishedAt)}
                        />
                      </span>
                    </div>
                  </div>
                </article>

                {popularPosts.slice(1).map((post) => (
                  <article class="post-card">
                    <div class="post-image">
                      {post.imageUrl ? (
                        <img src={post.imageUrl} alt={post.title} />
                      ) : (
                        `${post.categories?.[0]?.title || "Blog"} Content`
                      )}
                    </div>
                    <div class="post-content">
                      <span class="post-category">
                        {post.categories?.[0]?.title || "Blog"}
                      </span>
                      <h3 class="post-title">{post.title}</h3>
                      <p class="post-excerpt">A brief look at this post...</p>
                      <div class="post-meta">
                        <span>4 min read</span>
                        <span>
                          <FormattedDate date={new Date(post.publishedAt)} />
                        </span>
                      </div>
                    </div>
                  </article>
                ))}
              </>
            )
          }
        </div>
      </div>

      <div class="featured-posts">
        <h2>Featured This Week</h2>
        <div class="featured-list">
          {
            featuredPosts.map((post) => (
              <a
                href={`/${post.categories?.[0]?.slug || "blog"}/${post.slug.current}/`}
                class="featured-item"
              >
                <div class="featured-thumb">
                  {post.categories?.[0]?.title || "Post"} Photo
                </div>
                <div class="featured-content">
                  <h4>{post.title}</h4>
                  <div class="featured-meta">
                    {post.categories?.[0]?.title || "Blog"} â€¢ 5 min read
                  </div>
                </div>
              </a>
            ))
          }
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section class="quick-about">
      <div class="about-photo">Family Portrait Photo</div>
      <div class="about-content">
        <h3>Hey there, we're the Kaelins!</h3>
        <p>
          We're a family who recently made Kentucky our home. I'm a tech
          enthusiast who loves to code, cook, and cheer for our favorite sports
          teams. Join us as we share our adventures, family recipes, and the ups
          and downs of life in the Bluegrass State.
        </p>
        <a href="/about" class="about-link">Read Our Full Story</a>
      </div>
    </section>
  </main>
</BaseLayout>
