---
// src/components/RelatedPosts.astro
import { sanityClient } from '../../sanity.config.js';
import FormattedDate from './FormattedDate.astro';
import CategoryTags from './CategoryTags.astro';
import OptimizedImage from '../components/OptimizedImage.astro';

export interface Props {
  currentSlug?: string;
  categories?: Array<{title: string, slug: string}>;
  limit?: number;
}

const { currentSlug, categories = [], limit = 3 } = Astro.props;

// Build category filter for GROQ query
const categoryFilter = categories.length > 0 
  ? `&& references(*[_type == "category" && slug.current in [${categories.map(c => `"${c.slug}"`).join(', ')}]]._id)`
  : '';

const relatedPosts = await sanityClient.fetch(`
  *[_type == "post" ${currentSlug ? `&& slug.current != "${currentSlug}"` : ''} ${categoryFilter}] | order(publishedAt desc) [0...${limit}] {
    _id,
    title,
    slug,
    publishedAt,
    "imageUrl": mainImage.asset->url,
    "categories": categories[]->{title, "slug": slug.current},
    "excerpt": array::join(string::split(pt::text(body), "")[0..150], "") + "..."
  }
`);
---

{relatedPosts.length > 0 && (
  <section class="mt-8">
    <h2 class="text-center text-xl text-primary mb-6">Related Posts</h2>
      <div class="grid grid-cols-3 gap-8 sm:grid-cols-1">
        {relatedPosts.map((post: any) => (
          <article class="related-post m-4 p-8">
            <a href={`/${post.categories?.[0]?.slug}/${post.slug.current}/`} class="block no-underline text-inherit">
              <div class="space-y-3">         
              <h3 class="post-title text-sm mb-2 leading-tight">{post.title}</h3>
              {post.excerpt && (
                <p class="post-excerpt text-xs mb-2 line-clamp-3">{post.excerpt}</p>
              )}
            </div>
            {post.imageUrl && (
              <div class="aspect-[3/2] overflow-hidden">
                <OptimizedImage 
                  src={post.imageUrl} 
                  alt={post.title} 
                  width={200} 
                  height={133}
                  loading="lazy" 
                  sizes="(max-width: 768px) 100vw, 200px"
                  class="w-full h-full object-cover transition-transform duration-500"
                />
              </div>
            )}
          </a>
        </article>
      ))}
    </div>
  </section>
)}